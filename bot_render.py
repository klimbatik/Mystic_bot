import os
import asyncio
import logging
from aiogram import Bot, Dispatcher, F
from aiogram.client.default import DefaultBotProperties
from aiogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton
from aiogram.filters import Command

# üîê –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")

# üåê URL –≤–µ–±—Ö—É–∫–∞ (Render)
WEBHOOK_URL = f"https://{os.getenv('RENDER_EXTERNAL_HOSTNAME')}/webhook"

# üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–æ–≤
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# üõ†Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = Bot(token=BOT_TOKEN, default=DefaultBotProperties(parse_mode="HTML"))
dp = Dispatcher()

# üë§ –¢–≤–æ–π ID
ADMIN_ID = 1030370280

# –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–∂–∞–ª–∏ "–ì–û–¢–û–í–û"
waiting_for_date = set()

# ‚Äî‚Äî‚Äî —Ñ—É–Ω–∫—Ü–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ ‚Äî‚Äî‚Äî
def norm22(n: int) -> int:
    while n > 22:
        n = sum(int(digit) for digit in str(n))
    return n

# ‚Äî‚Äî‚Äî —Ä–∞—Å—á—ë—Ç —Ö–≤–æ—Å—Ç–∞ ‚Äî‚Äî‚Äî
def calc_tail(day: int, month: int, year: int):
    A = norm22(day)
    B = norm22(month)
    C = norm22(sum(int(d) for d in str(year)))
    D = norm22(A + B + C)
    E = norm22(A + B + C + D)
    M = norm22(D + E)
    N = norm22(M + D)
    return (M, N, D)

# ‚Äî‚Äî‚Äî –∫—Ä–∞—Ç–∫–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è ‚Äî‚Äî‚Äî
TAILS = {
    (18,6,6): "–õ—é–±–æ–≤–Ω–∞—è –º–∞–≥–∏—è ‚Äî –æ–ø—ã—Ç —Å–∏–ª—å–Ω–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏/–ø—Ä–∏–≤—è–∑–∫–∏.",
    (9,9,18): "–í–æ–ª—à–µ–±–Ω–∏–∫, –º–∞–≥–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞–Ω–∏—è ‚Äî –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–π–Ω—ã–º –∑–Ω–∞–Ω–∏—è–º.",
    (9,18,9): "–ú–∞–≥–∏—á–µ—Å–∫–∞—è –∂–µ—Ä—Ç–≤–∞ ‚Äî —Ç–µ–º–∞ –∂–µ—Ä—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–¥–∏ –∏–¥–µ–∏/—Ä–∏—Ç—É–∞–ª–∞.",
    (18,9,9): "–í–æ–ª—à–µ–±–Ω–∏–∫. –û—Ç—à–µ–ª—å–Ω–∏—á–µ—Å—Ç–≤–æ ‚Äî –∏–∑–æ–ª—è—Ü–∏—è —Ä–∞–¥–∏ –∑–Ω–∞–Ω–∏–π.",
    (6,5,17): "–ì–æ—Ä–¥—ã–Ω—è ‚Äî –∏—Å–ø—ã—Ç–∞–Ω–∏–µ —Å–ª–∞–≤–æ–π –∏ —Å–∞–º–æ—Ü–µ–Ω–Ω–æ—Å—Ç—å—é.",
    (15,20,5): "–ë—É–Ω—Ç–∞—Ä—å ‚Äî —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º.",
    (15,5,8): "–ü—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞, —Å—Ç—Ä–∞—Å—Ç–∏ –≤ —Å–µ–º—å–µ ‚Äî –∏—Å–ø—ã—Ç–∞–Ω–∏—è –≤ —Ä–æ–¥–µ.",
    (3,9,12): "–û–¥–∏–Ω–æ–∫–∞—è –∂–µ–Ω—â–∏–Ω–∞ ‚Äî –ø—É—Ç—å —á–µ—Ä–µ–∑ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ –∏ —Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏–µ.",
    (3,12,9): "–û–¥–∏–Ω–æ–∫–∞—è –∂–µ–Ω—â–∏–Ω–∞ ‚Äî –ø—É—Ç—å —á–µ—Ä–µ–∑ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ –∏ —Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏–µ.",
    (9,12,3): "–û–¥–∏–Ω–æ–∫–∞—è –∂–µ–Ω—â–∏–Ω–∞ ‚Äî –ø—É—Ç—å —á–µ—Ä–µ–∑ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ –∏ —Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏–µ.",
    (15,8,11): "–§–∏–∑–∏—á–µ—Å–∫–∞—è –∞–≥—Ä–µ—Å—Å–∏—è ‚Äî —Ä–∞–±–æ—Ç–∞ —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –≥–Ω–µ–≤–æ–º.",
    (9,15,6): "–ú–∏—Ä —Å—Ç—Ä–∞—Å—Ç–µ–π –∏ —Å–∫–∞–∑–æ–∫ ‚Äî —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –∏–ª–ª—é–∑–∏—è–º.",
    (6,17,11): "–ó–∞–≥—É–±–ª–µ–Ω–Ω—ã–π —Ç–∞–ª–∞–Ω—Ç ‚Äî —Å–∫—Ä—ã—Ç—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ –Ω–µ–¥–æ–æ—Ü–µ–Ω–∫–∞.",
    (12,19,7): "–í–æ–∏–Ω ‚Äî –±–æ—Ä—å–±–∞ –∑–∞ –ø—Ä–∞–≤–¥—É –∏ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å.",
    (21,4,10): "–£–≥–Ω–µ—Ç—ë–Ω–Ω–∞—è –¥—É—à–∞ ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –±–ª–æ–∫–∏.",
    (12,16,4): "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä ‚Äî —Å–∏–ª–∞ –≤–æ–ª–∏, –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ –ª–∏–¥–µ—Ä—Å—Ç–≤–æ.",
    (3,22,19): "–ù–µ —Ä–æ–∂–¥—ë–Ω–Ω–æ–µ –¥–∏—Ç—è ‚Äî –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–µ —É—Ç—Ä–∞—Ç—ã –∏ –ø–æ—Ç–µ—Ä–∏.",
    (21,10,16): "–î—É—Ö–æ–≤–Ω—ã–π –∂—Ä–µ—Ü ‚Äî —Ä–∞–±–æ—Ç–∞ —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –∏ –º–∏—Å—Ç–∏–∫–æ–π.",
    (6,8,20): "–†–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–¥–∞ ‚Äî –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –ø—Ä–µ–¥–∫–æ–≤.",
    (3,7,22): "–£–∑–Ω–∏–∫ ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤.",
    (9,3,21): "–ù–∞–¥–∑–∏—Ä–∞—Ç–µ–ª—å ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –Ω–∞–¥ –¥—Ä—É–≥–∏–º–∏.",
    (21,7,13): "–†–∞–∑—Ä—É—à–µ–Ω–∏–µ –∏ —Å–º–µ—Ä—Ç—å –º–Ω–æ–≥–∏–º –¥—É—à–∞–º ‚Äî —Ç—è–∂–µ–ª–∞—è –∫–∞—Ä–º–∞ —Ä–æ–¥–∞.",
    (18,6,15): "–¢—ë–º–Ω—ã–π –º–∞–≥ ‚Äî —Å–∏–ª–∞ –∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ —ç–Ω–µ—Ä–≥–∏–µ–π.",
    (6,20,14): "–î—É—à–∞, –∫–æ—Ç–æ—Ä—É—é –ø—Ä–∏–Ω–µ—Å–ª–∏ –≤ –∂–µ—Ä—Ç–≤—É ‚Äî –ø—É—Ç—å —á–µ—Ä–µ–∑ –∂–µ—Ä—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å.",
    (21,10,7): "–í–æ–∏–Ω –≤–µ—Ä—ã ‚Äî –¥—É—Ö–æ–≤–Ω—ã–µ –∏—Å–ø—ã—Ç–∞–Ω–∏—è –∏ –≤–µ—Ä–∞.",
    (3,13,10): "–°—É–∏—Ü–∏–¥ ‚Äî —É—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ –∫—Ä–∏–∑–∏—Å—ã –∏ –æ—Ç—á–∞—è–Ω–∏–µ.",
    (12,18,3): "–§–∏–∑–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä–∞–¥–∞–Ω–∏—è ‚Äî –∏—Å–ø—ã—Ç–∞–Ω–∏—è —Ç–µ–ª–æ–º –∏ –¥—É—Ö–æ–º.",
    (18,3,12): "–§–∏–∑–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä–∞–¥–∞–Ω–∏—è ‚Äî –∏—Å–ø—ã—Ç–∞–Ω–∏—è —Ç–µ–ª–æ–º –∏ –¥—É—Ö–æ–º.",
    (6,14,8): "–î–∏–∫—Ç–∞—Ç–æ—Ä ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å, –≤–ª–∞—Å—Ç—å –∏ –ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ª–∏ –¥—Ä—É–≥–∏—Ö.",
}

def describe_tail(triplet):
    return TAILS.get(triplet, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ö–≤–æ—Å—Ç")

# ‚Äî‚Äî‚Äî –ø–æ–¥—Ä–æ–±–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è ‚Äî‚Äî‚Äî
DETAILED_DESCRIPTIONS = {
    (18,6,6): (
        "–í –ø—Ä–æ—à–ª–æ–π –∂–∏–∑–Ω–∏ —Ç—ã –ª–∏–±–æ —Å–æ–≤–µ—Ä—à–∞–ª –ª—é–±–æ–≤–Ω—ã–µ –ø—Ä–∏–≤–æ—Ä–æ—Ç—ã, –ª–∏–±–æ —Å–∞–º —Å—Ç—Ä–∞–¥–∞–ª –æ—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ –ª—é–±–≤–∏. "
        "–ß–∞—Å—Ç–æ —ç—Ç–æ –ø—Ä–æ—è–≤–ª—è–ª–æ—Å—å –∫–∞–∫ —Å–∏–ª—å–Ω–∞—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∏–ª–∏ –ø—Ä–∏–Ω—É–∂–¥–µ–Ω–∏–µ.\n\n"
        "–í —ç—Ç–æ–π –∂–∏–∑–Ω–∏ —Ç—ã –º–æ–∂–µ—à—å –±–µ—Å—Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ –∏—Å–∫–∞—Ç—å –ª—é–±–æ–≤—å –≤–æ–≤–Ω–µ, –Ω–µ —É–º–µ—è –ø–æ–ª—é–±–∏—Ç—å —Å–µ–±—è. "
        "–¢–µ–±–µ –≤–∞–∂–Ω–æ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö, –∏ —Ç—ã –º–æ–∂–µ—à—å –±—ã—Ç—å —Å–∫–ª–æ–Ω–µ–Ω –∫ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è–º —á–µ—Ä–µ–∑ —á—É–≤—Å—Ç–≤–∞.\n\n"
        "‚ùó <b>–ó–∞–¥–∞—á–∏ —ç—Ç–æ–≥–æ —Ö–≤–æ—Å—Ç–∞:</b>\n"
        "‚Ä¢ –ü–æ–ª—é–±–∏—Ç—å —Å–µ–±—è –∏ –Ω–∞—É—á–∏—Ç—å—Å—è –¥–∞—Ä–∏—Ç—å –ª—é–±–æ–≤—å –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.\n"
        "‚Ä¢ –ù–µ —Ü–∏–∫–ª–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö ‚Äî –∏–Ω–∞—á–µ –¥—Ä—É–≥–∏–µ —Å—Ñ–µ—Ä—ã –∂–∏–∑–Ω–∏ –±—É–¥—É—Ç —Å—Ç—Ä–∞–¥–∞—Ç—å.\n"
        "‚Ä¢ –ü—Ä–æ–π—Ç–∏ –∏—Å–∫—É—à–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞–≥–∏—é ‚Äî –∏ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –Ω–µ—ë.\n"
        "‚Ä¢ –†–∞–∑–≤–∏–≤–∞—Ç—å –∏–Ω—Ç—É–∏—Ü–∏—é –∏ –≤—ã–±–∏—Ä–∞—Ç—å –ø—É—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –æ—Ç–∫–ª–∏–∫—É, –∞ –Ω–µ –ø–æ –≤—ã–≥–æ–¥–µ.\n"
        "‚Ä¢ –°—Ç–∞—Ç—å —Å–º–µ–ª—ã–º, —Ä–µ—à–∏—Ç–µ–ª—å–Ω—ã–º –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º ‚Äî —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞ –∂–∏–∑–Ω—å –Ω–∞—á–Ω—ë—Ç –≤—ã—Å—Ç—Ä–∞–∏–≤–∞—Ç—å—Å—è –≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ."
    ),
    (9,9,18): (
        "–¢—ã –æ–±–ª–∞–¥–∞–ª –≥–ª—É–±–æ–∫–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏, –Ω–æ –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –∏—Ö –º–∏—Ä—É. –ú–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –≤–æ –≤—Ä–µ–¥ –∏–ª–∏ –∏–∑ —Å—Ç—Ä–∞—Ö–∞ –±—ã—Ç—å –Ω–µ–ø–æ–Ω—è—Ç—ã–º.\n\n"
        "–í —ç—Ç–æ–π –∂–∏–∑–Ω–∏ —Ç—ã –º–æ–∂–µ—à—å –±–æ—è—Ç—å—Å—è –¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏, –¥—É–º–∞—è: ¬´–ú–æ–∏ –∑–Ω–∞–Ω–∏—è –Ω–∏–∫–æ–º—É –Ω–µ –Ω—É–∂–Ω—ã¬ª –∏–ª–∏ ¬´–ù–µ —Ö–æ—á—É —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–µ–±–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤¬ª.\n\n"
        "‚ùó <b>–ó–∞–¥–∞—á–∏ —ç—Ç–æ–≥–æ —Ö–≤–æ—Å—Ç–∞:</b>\n"
        "‚Ä¢ –ü—Ä–∏–Ω—è—Ç—å, —á—Ç–æ —Ç–≤–æ—è –¥—É—à–∞ –º—É–¥—Ä–∞ –∏ –æ–ø—ã—Ç–Ω–∞.\n"
        "‚Ä¢ –ù–∞—á–∞—Ç—å –¥–µ–ª–∏—Ç—å—Å—è –º—É–¥—Ä–æ—Å—Ç—å—é ‚Äî —á–µ—Ä–µ–∑ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ, –±–ª–æ–≥, —Ö–æ–±–±–∏.\n"
        "‚Ä¢ –ü–æ–º–æ–≥–∞—Ç—å –ª—é–¥—è–º, –Ω–µ –Ω–∞–∑–∏–¥–∞—è, –∞ –¥–µ–ª—è—Å—å –æ–ø—ã—Ç–æ–º.\n"
        "‚Ä¢ –ò–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç —Å—Ç—Ä–∞—Ö–∞ –∏ –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∑–Ω–∞–Ω–∏—è.\n"
        "‚Ä¢ –ù–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è –≤ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–µ ‚Äî —Å–æ–∑–¥–∞–π –∫–æ–º–∞–Ω–¥—É –µ–¥–∏–Ω–æ–º—ã—à–ª–µ–Ω–Ω–∏–∫–æ–≤."
    ),
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è
}

# ‚Äî‚Äî‚Äî —Å—Å—ã–ª–∫–∏ –Ω–∞ PDF ‚Äî‚Äî‚Äî
PDF_LINKS = {
    (18,6,6): "https://drive.google.com/file/d/10R1PoK8lQbcP5fEVVXecMoLymi45tsGW/view?usp=drive_link",
    (9,9,18): "https://drive.google.com/file/d/1QaMYUJv--n8iLwseG8_MAgz79dggEgg6/view?usp=drive_link",
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ
}

# ‚Äî‚Äî‚Äî –∫–Ω–æ–ø–∫–∏ ‚Äî‚Äî‚Äî
start_keyboard = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="–°–¥–µ–ª–∞—Ç—å –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑")],
        [KeyboardButton(text="–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª Master Mystic")]
    ],
    resize_keyboard=True
)

subscribe_button = InlineKeyboardMarkup(
    inline_keyboard=[
        [InlineKeyboardButton(text="–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è", url="https://t.me/Master_Mystic")]
    ]
)

# ‚Äî‚Äî‚Äî –∫–æ–º–∞–Ω–¥–∞ /start ‚Äî‚Äî‚Äî
@dp.message(Command("start"))
async def start(message: Message):
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –Ω–∞—á–∞–ª —á–∞—Ç")
    await message.answer(
        "–ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî –±–æ—Ç <b>Master Mystic</b> üåø\n\n"
        "–Ø –ø–æ–º–æ–≥—É —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ç–≤–æ–π <i>–ö–∞—Ä–º–∏—á–µ—Å–∫–∏–π —Ö–≤–æ—Å—Ç</i> –∏ —É–∑–Ω–∞—Ç—å –≥–ª–∞–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –¥—É—à–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –ø—Ä–∏—Ç–∞—â–∏–ª(–∞) –∏–∑ –ø—Ä–æ—à–ª–æ–π –∂–∏–∑–Ω–∏. –ß—Ç–æ –º–µ—à–∞–µ—Ç —Ç–µ–±–µ –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø–µ—Ä—ë–¥.\n\n"
        "–≠—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ.\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ <b>–î–î.–ú–ú.–ì–ì–ì–ì</b>",
        reply_markup=start_keyboard
    )

# ‚Äî‚Äî‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è" ‚Äî‚Äî‚Äî
@dp.message(F.text == "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª Master Mystic")
async def subscribe(message: Message):
    await message.answer(
        "üîπ –ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Å—è –Ω–∞ –∫–∞–Ω–∞–ª, –≥–¥–µ —è –¥–µ–ª—é—Å—å:\n"
        "‚Ä¢ –ö–µ–π—Å–∞–º–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤\n"
        "‚Ä¢ –≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–æ–π –∫–∞–º–Ω–µ–π\n"
        "‚Ä¢ –ö–∞–∫ –º–µ–Ω—è—Ç—å –∂–∏–∑–Ω—å —á–µ—Ä–µ–∑ –º–∞—Ç—Ä–∏—Ü—É —Å—É–¥—å–±—ã\n\n"
        "–ë—É–¥–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ!",
        reply_markup=subscribe_button
    )

# ‚Äî‚Äî‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ "–°–¥–µ–ª–∞—Ç—å –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑" ‚Äî‚Äî‚Äî
@dp.message(F.text == "–°–¥–µ–ª–∞—Ç—å –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑")
async def full_analysis(message: Message):
    payment_button = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", callback_data="pay")],
            [InlineKeyboardButton(text="‚è∏ –Ø –ø–æ–¥—É–º–∞—é", callback_data="think")]
        ]
    )
    await message.answer(
        "<b>–û—Ç–ª–∏—á–Ω–æ! –í –ø–æ–ª–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ —Ç—ã —É–∑–Ω–∞–µ—à—å:</b>\n"
        "‚óè –î–µ–Ω–µ–∂–Ω—ã–π –∫–æ–¥\n"
        "‚óè –ü—Ä–∏–∑–≤–∞–Ω–∏–µ –∏ –ø—É—Ç—å –¥—É—à–∏\n"
        "‚óè –ö–∞—Ä–º–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏\n"
        "‚óè –ó–æ–Ω—ã —Å–∏–ª—ã –∏ —Å–ª–∞–±–æ—Å—Ç–∏\n\n"
        "<b>üí≤ –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –ú–∞—Ç—Ä–∏—Ü–µ —Å—É–¥—å–±—ã –±—É–¥–µ—Ç —Å—Ç–æ–∏—Ç—å 1000‚ÇΩ.</b>\n\n"
        "–≠—Ç–æ –Ω–µ –≥–∞–¥–∞–Ω–∏–µ, —ç—Ç–æ –∞–Ω–∞–ª–∏–∑ –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è. –•–æ—á–µ—à—å –ø–æ–ª—É—á–∏—Ç—å? –ñ–º–∏ ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª ‚Äî –∏ —è –ø—Ä–∏—à–ª—é —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã ‚Äî –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤ –ø—Ä–∏—à–ª—é –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞—Å—á—ë—Ç.",
        reply_markup=payment_button
    )

# ‚Äî‚Äî‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" ‚Äî‚Äî‚Äî
@dp.callback_query(F.data == "pay")
async def send_payment_info(callback):
    payment_info = (
        "üí≥ <b>–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã:</b>\n\n"
        "–°–±–µ—Ä–±–∞–Ω–∫: <code>4276 5400 2708 8180</code>\n\n"
        "–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É <b>–ì–û–¢–û–í–û</b> ‚Äî –∏ —è –ø—Ä–∏—à–ª—é —Ä–∞—Å—á—ë—Ç."
    )
    ready_button = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="‚úÖ –ì–û–¢–û–í–û", callback_data="ready")]
        ]
    )
    await callback.message.edit_text(payment_info, reply_markup=ready_button, parse_mode="HTML")

# ‚Äî‚Äî‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ "–ì–û–¢–û–í–û" ‚Äî‚Äî‚Äî
@dp.callback_query(F.data == "ready")
async def send_contact(callback):
    waiting_for_date.add(callback.from_user.id)
    await callback.message.edit_text(
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ <b>–î–î.–ú–ú.–ì–ì–ì–ì</b> (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15.04.1990):",
        reply_markup=None,
        parse_mode="HTML"
    )

# ‚Äî‚Äî‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –¥–∞—Ç—ã –ø–æ—Å–ª–µ "–ì–û–¢–û–í–û" ‚Äî‚Äî‚Äî
@dp.message(F.text)
async def process_date(message: Message):
    if message.from_user.id not in waiting_for_date:
        return

    try:
        day, month, year = map(int, message.text.split("."))
    except:
        await message.reply("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã. –í–≤–µ–¥–∏—Ç–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì.")
        return

    if not (1 <= day <= 31) or not (1 <= month <= 12) or year < 1900:
        await message.reply("‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –¥–∞—Ç—É.")
        return

    waiting_for_date.discard(message.from_user.id)

    try:
        await bot.send_message(
            chat_id=ADMIN_ID,
            text=f"–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç: {message.from_user.full_name}\n"
                 f"–Æ–∑–µ—Ä–Ω–µ–π–º: @{message.from_user.username or '–Ω–µ—Ç'}\n"
                 f"–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: {day}.{month}.{year}"
        )
        logger.info(f"–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∞–¥–º–∏–Ω—É: {day}.{month}.{year}")
    except Exception as e:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω—É: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.")

    await message.answer(
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –¥–æ–≤–µ—Ä–∏–µ üôè. –í —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤ —è –ø—Ä–∏—à–ª—é –≤–∞–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç. "
        "–ï—Å–ª–∏ —É –≤–∞—Å –±—É–¥—É—Ç –≤–æ–ø—Ä–æ—Å—ã, –ø–∏—à–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è <a href='https://t.me/Mattrehka'>Master Mystic</a>",
        parse_mode="HTML"
    )

# ‚Äî‚Äî‚Äî –û–°–ù–û–í–ù–û–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–ê–¢–´ (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑) ‚Äî‚Äî‚Äî
@dp.message(F.text.regexp(r"^(\d{2})\.(\d{2})\.(\d{4})$"))
async def handle_date(message: Message):
    if message.from_user.id in waiting_for_date:
        return

    try:
        day, month, year = map(int, message.text.split("."))
    except:
        await message.reply("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã. –í–≤–µ–¥–∏—Ç–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì.")
        return

    if not (1 <= day <= 31) or not (1 <= month <= 12) or year < 1900:
        await message.reply("‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –¥–∞—Ç—É.")
        return

    tail_triplet = calc_tail(day, month, year)
    description = describe_tail(tail_triplet)
    detailed_text = DETAILED_DESCRIPTIONS.get(tail_triplet, "–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.")

    inline_keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="üìñ –ß–∏—Ç–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏", url=PDF_LINKS.get(tail_triplet, "#"))],
            [InlineKeyboardButton(text="‚úÖ –Ø –ø—Ä–æ—á–∏—Ç–∞–ª ‚Äî —Å–¥–µ–ª–∞—Ç—å –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑", callback_data="full_analysis")]
        ]
    )

    await message.answer(
        f"üîÆ <b>–¢–≤–æ–π –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–π —Ö–≤–æ—Å—Ç:</b> {tail_triplet[0]}-{tail_triplet[1]}-{tail_triplet[2]}\n"
        f"üìå {description}\n\n"
        f"{detailed_text}",
        reply_markup=inline_keyboard
    )

# ‚Äî‚Äî‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ "–Ø –ø—Ä–æ—á–∏—Ç–∞–ª ‚Äî —Å–¥–µ–ª–∞—Ç—å –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑" ‚Äî‚Äî‚Äî
@dp.callback_query(F.data == "full_analysis")
async def callback_full_analysis(callback):
    payment_button = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", callback_data="pay")],
            [InlineKeyboardButton(text="‚è∏ –Ø –ø–æ–¥—É–º–∞—é", callback_data="think")]
        ]
    )
    await callback.message.edit_text(
        "<b>–û—Ç–ª–∏—á–Ω–æ! –í –ø–æ–ª–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ —Ç—ã —É–∑–Ω–∞–µ—à—å:</b>\n"
        "‚óè –î–µ–Ω–µ–∂–Ω—ã–π –∫–æ–¥\n"
        "‚óè –ü—Ä–∏–∑–≤–∞–Ω–∏–µ –∏ –ø—É—Ç—å –¥—É—à–∏\n"
        "‚óè –ö–∞—Ä–º–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏\n"
        "‚óè –ó–æ–Ω—ã —Å–∏–ª—ã –∏ —Å–ª–∞–±–æ—Å—Ç–∏\n\n"
        "<b>üí≤ –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –ú–∞—Ç—Ä–∏—Ü–µ —Å—É–¥—å–±—ã –±—É–¥–µ—Ç —Å—Ç–æ–∏—Ç—å 1000‚ÇΩ.</b>\n\n"
        "–≠—Ç–æ –Ω–µ –≥–∞–¥–∞–Ω–∏–µ, —ç—Ç–æ –∞–Ω–∞–ª–∏–∑ –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è. –•–æ—á–µ—à—å –ø–æ–ª—É—á–∏—Ç—å? –ñ–º–∏ ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª ‚Äî –∏ —è –ø—Ä–∏—à–ª—é —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã ‚Äî –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤ –ø—Ä–∏—à–ª—é –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞—Å—á—ë—Ç.",
        reply_markup=payment_button
    )

# ‚Äî‚Äî‚Äî –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ ‚Äî‚Äî‚Äî
async def main():
    from aiohttp import web
    from aiogram.webhook.aiohttp_server import SimpleRequestHandler

    try:
        webhook_info = await bot.get_webhook_info()
        if webhook_info.url != WEBHOOK_URL:
            await bot.set_webhook(WEBHOOK_URL)
            logger.info(f"‚úÖ Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {WEBHOOK_URL}")
        else:
            logger.info(f"‚úÖ Webhook —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {WEBHOOK_URL}")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ webhook: {e}")

    app = web.Application()
    SimpleRequestHandler(dispatcher=dp, bot=bot).register(app, path="/webhook")
    runner = web.AppRunner(app)
    await runner.setup()
    site = web.TCPSite(runner, host="0.0.0.0", port=int(os.getenv("PORT", 10000)))
    await site.start()
    logger.info("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Å–ª—É—à–∞–µ—Ç webhook")

    try:
        await asyncio.sleep(3600)
    finally:
        await runner.cleanup()

if __name__ == "__main__":
    asyncio.run(main())
