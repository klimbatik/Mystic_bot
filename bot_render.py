import os
import asyncio
from aiogram import Bot, Dispatcher, F
from aiogram.client.default import DefaultBotProperties  # ✅ Правильный импорт!
from aiogram.types import Message
from aiogram.filters import Command

# 🔐 Получаем токен из переменных окружения
BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN не установлен в переменных окружения. Зайди в Render и добавь его!")

# 📢 Ссылка на канал (убедись, что нет пробелов!)
CHANNEL_LINK = "https://t.me/Master_Mystic"

# 🛠️ Создаём бота с HTML-разметкой
bot = Bot(token=BOT_TOKEN, default=DefaultBotProperties(parse_mode="HTML"))
dp = Dispatcher()

# ——— функция нормализации числа до 1..22 ———
def norm22(n: int) -> int:
    while n > 22:
        n = sum(int(digit) for digit in str(n))
    return n

# ——— расчёт кармического хвоста ———
def calc_tail(day: int, month: int, year: int):
    A = norm22(day)
    B = norm22(month)
    C = norm22(sum(int(d) for d in str(year)))
    D = norm22(A + B + C)
    E = norm22(A + B + C + D)
    M = norm22(D + E)
    N = norm22(M + D)
    return (M, N, D)

# ——— словарь трактовок кармических хвостов ———
TAILS = {
    (18,6,6): "Любовная магия — опыт сильной зависимости/привязки.",
    (9,9,18): "Волшебник, магические знания — доступ к тайным знаниям.",
    (9,18,9): "Магическая жертва — тема жертвенности ради идеи/ритуала.",
    (18,9,9): "Волшебник. Отшельничество — изоляция ради знаний.",
    (6,5,17): "Гордыня — испытание славой и самоценностью.",
    (15,20,5): "Бунтарь — сопротивление установленным правилам.",
    (15,5,8): "Предательства, страсти в семье — испытания в роде.",
    (3,9,12): "Одинокая женщина — путь через одиночество и самопознание.",
    (3,12,9): "Одинокая женщина — путь через одиночество и самопознание.",
    (9,12,3): "Одинокая женщина — путь через одиночество и самопознание.",
    (15,8,11): "Физическая агрессия — работа с внутренним гневом.",
    (9,15,6): "Мир страстей и сказок — склонность к иллюзиям.",
    (6,17,11): "Загубленный талант — скрытые способности и недооценка.",
    (12,19,7): "Воин — борьба за правду и справедливость.",
    (21,4,10): "Угнетённая душа — внутренние ограничения и блоки.",
    (12,16,4): "Император — сила воли, контроль и лидерство.",
    (3,22,19): "Не рожденное дитя — кармические утраты и потери.",
    (21,10,16): "Духовный жрец — работа с внутренними знаниями и мистикой.",
    (6,8,20): "Разочарование рода — кармические ошибки предков.",
    (3,7,22): "Узник — ограничения и зависимость от обстоятельств.",
    (9,3,21): "Надзиратель — контроль и наблюдение над другими.",
    (21,7,13): "Разрушение и смерть многим душам — тяжелая карма рода.",
    (18,6,15): "Тёмный маг — сила и манипуляции энергией.",
    (6,20,14): "Душа, которую принесли в жертву — путь через жертвенность.",
    (21,10,7): "Воин веры — духовные испытания и вера.",
    (3,13,10): "Суицид — уроки через кризисы и отчаяние.",
    (12,18,3): "Физические страдания — испытания телом и духом.",
    (18,3,12): "Физические страдания — испытания телом и духом.",
}

def describe_tail(triplet):
    return TAILS.get(triplet, "Неизвестный хвост — описание пока отсутствует.")

# ——— обработчики команд ———
@dp.message(Command("start"))
async def start(message: Message):
    await message.answer(
        "Привет! Я бот <b>Master Mystic</b> 🌿\n"
        "Я рассчитываю твой <i>кармический хвост</i> по дате рождения.\n\n"
        "👉 Используй команду:\n"
        "<code>/tail ДД.ММ.ГГГГ</code> — чтобы узнать свой путь."
    )

@dp.message(Command("tail"))
async def tail_command(message: Message):
    parts = message.text.split(maxsplit=1)
    if len(parts) < 2:
        await message.reply(
            "❌ Укажи дату в формате:\n"
            "<code>/tail ДД.ММ.ГГГГ</code>"
        )
        return

    try:
        day, month, year = map(int, parts[1].split("."))
    except Exception:
        await message.reply(
            "⚠️ Неверный формат даты.\n"
            "Используй: <code>ДД.ММ.ГГГГ</code>"
        )
        return

    # Проверка диапазона дат
    if not (1 <= day <= 31) or not (1 <= month <= 12) or year < 1900:
        await message.reply("⚠️ Пожалуйста, введи корректную дату.")
        return

    tail_triplet = calc_tail(day, month, year)
    description = describe_tail(tail_triplet)

    await message.answer(
        f"🔮 <b>Твой кармический хвост:</b> {tail_triplet[0]}-{tail_triplet[1]}-{tail_triplet[2]}\n"
        f"📌 {description}\n\n"
        f"👉 Подпишись на канал, чтобы получать больше магических знаний:\n"
        f"<a href='{CHANNEL_LINK}'>Master Mystic</a>"
    )

# ——— запуск бота ———
if __name__ == "__main__":
    print("✅ Бот запущен и готов к работе...")
    asyncio.run(dp.start_polling(bot))