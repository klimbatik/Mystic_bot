import os
import asyncio
from aiogram import Bot, Dispatcher, F
from aiogram.client.default import DefaultBotProperties
from aiogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton
from aiogram.filters import Command

# ?? Переменные окружения
BOT_TOKEN = os.getenv("BOT_TOKEN")
CHANNEL_ID = "@Master_Mystic"
if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN не установлен в переменных окружения")

# ?? URL вебхука
WEBHOOK_URL = f"https://{os.getenv('RENDER_EXTERNAL_HOSTNAME')}/webhook"

# ??? Инициализация бота
bot = Bot(token=BOT_TOKEN, default=DefaultBotProperties(parse_mode="HTML"))
dp = Dispatcher()

# ——— функция нормализации ———
def norm22(n: int) -> int:
    while n > 22:
        n = sum(int(digit) for digit in str(n))
    return n

# ——— расчёт хвоста ———
def calc_tail(day: int, month: int, year: int):
    A = norm22(day)
    B = norm22(month)
    C = norm22(sum(int(d) for d in str(year)))
    D = norm22(A + B + C)
    E = norm22(A + B + C + D)
    M = norm22(D + E)
    N = norm22(M + D)
    return (M, N, D)

# ——— краткие описания ———
TAILS = {
    (18,6,6): "Любовная магия — опыт сильной зависимости/привязки.",
    (9,9,18): "Волшебник, магические знания — доступ к тайным знаниям.",
    (9,18,9): "Магическая жертва — тема жертвенности ради идеи/ритуала.",
    (18,9,9): "Волшебник. Отшельничество — изоляция ради знаний.",
    (6,5,17): "Гордыня — испытание славой и самоценностью.",
    (15,20,5): "Бунтарь — сопротивление установленным правилам.",
    (15,5,8): "Предательства, страсти в семье — испытания в роде.",
    (3,9,12): "Одинокая женщина — путь через одиночество и самопознание.",
    (3,12,9): "Одинокая женщина — путь через одиночество и самопознание.",
    (9,12,3): "Одинокая женщина — путь через одиночество и самопознание.",
    (15,8,11): "Физическая агрессия — работа с внутренним гневом.",
    (9,15,6): "Мир страстей и сказок — склонность к иллюзиям.",
    (6,17,11): "Загубленный талант — скрытые способности и недооценка.",
    (12,19,7): "Воин — борьба за правду и справедливость.",
    (21,4,10): "Угнетённая душа — внутренние ограничения и блоки.",
    (12,16,4): "Император — сила воли, контроль и лидерство.",
    (3,22,19): "Не рождённое дитя — кармические утраты и потери.",
    (21,10,16): "Духовный жрец — работа с внутренними знаниями и мистикой.",
    (6,8,20): "Разочарование рода — кармические ошибки предков.",
    (3,7,22): "Узник — ограничения и зависимость от обстоятельств.",
    (9,3,21): "Надзиратель — контроль и наблюдение над другими.",
    (21,7,13): "Разрушение и смерть многим душам — тяжелая карма рода.",
    (18,6,15): "Тёмный маг — сила и манипуляции энергией.",
    (6,20,14): "Душа, которую принесли в жертву — путь через жертвенность.",
    (21,10,7): "Воин веры — духовные испытания и вера.",
    (3,13,10): "Суицид — уроки через кризисы и отчаяние.",
    (12,18,3): "Физические страдания — испытания телом и духом.",
    (18,3,12): "Физические страдания — испытания телом и духом.",
    (6,14,8): "Диктатор — контроль, власть и подавление воли других.",
}

def describe_tail(triplet):
    return TAILS.get(triplet, "Неизвестный хвост")

# ——— подробные описания ———
DETAILED_DESCRIPTIONS = {
    (18,6,6): (
        "В прошлой жизни ты либо совершал любовные привороты, либо сам страдал от недостатка любви. "
        "Часто это проявлялось как сильная эмоциональная привязка, зависимость или принуждение.\n\n"
        "В этой жизни ты можешь бессознательно искать любовь вовне, не умея полюбить себя. "
        "Тебе важно одобрение других, и ты можешь быть склонен к манипуляциям через чувства.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Полюбить себя и научиться дарить любовь без зависимости.\n"
        "• Не циклиться только на отношениях — иначе другие сферы жизни будут страдать.\n"
        "• Пройти искушение использовать магию — и отказаться от неё.\n"
        "• Развивать интуицию и выбирать путь по внутреннему отклику, а не по выгоде.\n"
        "• Стать смелым, решительным и ответственным — только тогда жизнь начнёт выстраиваться гармонично."
    ),
    (9,9,18): (
        "Ты обладал глубокими знаниями, но не передал их миру. Мог использовать их во вред или из страха быть непонятым.\n\n"
        "В этой жизни ты можешь бояться делиться своими знаниями, думая: «Мои знания никому не нужны» или «Не хочу создавать себе конкурентов».\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Принять, что твоя душа мудра и опытна.\n"
        "• Начать делиться мудростью — через творчество, блог, хобби.\n"
        "• Помогать людям, не назидая, а делясь опытом.\n"
        "• Избавиться от страха и начать передавать знания.\n"
        "• Не закрываться в одиночестве — создай команду единомышленников."
    ),
    (9,18,9): (
        "Ты был жертвой магического воздействия или сам приносил себя в жертву ради идеи. "
        "Ты помнишь это на уровне души и в этой жизни боишься, что кто-то может навести на тебя порчу.\n\n"
        "Ты как «ежик» — колючий, заметный, держишься особняком. Это защита, но она мешает строить доверительные отношения.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Убрать чувство постоянной опасности.\n"
        "• Изучать ситуацию, а не убегать от неё.\n"
        "• Не прятаться, а брать время на размышление.\n"
        "• Не поддаваться провокациям быть «жертвой»."
    ),
    (18,9,9): (
        "Ты обладал глубокими знаниями, но скрывал их, боясь быть осуждённым или сожжённым. "
        "Ты мог быть учёным, знахарем, монахом — но не передал своё знание потомкам.\n\n"
        "В этой жизни ты можешь бояться учить, бояться, что тебя не поймут. "
        "Могут быть установки: «Не умничай», «Закрой рот, мал ещё».\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Принять, что твоя мудрость нужна миру.\n"
        "• Начать делиться знаниями — через творчество, блог, встречи.\n"
        "• Не оставаться в одиночестве — создай семью, друзей.\n"
        "• Реализовывайся в творчестве и не живи в иллюзиях."
    ),
    (6,5,17): (
        "Ты возгордился своим талантом, красотой или положением и унижал других. "
        "Ты чувствовал себя звездой с рождения.\n\n"
        "В этой жизни ты можешь попадать в ситуации унижения — это отработка кармы. "
        "Ты хочешь всё сразу, просто так, без усилий.\n\n"
        "?<b>Задачи этого хвоста:</b>\n"
        "• Исцели гордыню. Не считай других «недостойными».\n"
        "• Иди к цели шаг за шагом, своим трудом.\n"
        "• Не жди, что всё свалится с неба.\n"
        "• Приди к пониманию: лучше вырастить генерала из солдата, чем сразу стать генералом."
    ),
    (15,20,5): (
        "Ты отверг традиции рода и был отвергнут ими в ответ. "
        "Ты мог уйти из семьи, выбрать не ту профессию, влюбиться не в того.\n\n"
        "В этой жизни ты можешь порвать связи с родственниками, чувствовать себя «белой вороной». "
        "Возможны саморазрушающие поведения: алкоголизм, игромания.\n\n"
        "?<b>Задачи этого хвоста:</b>\n"
        "• Найди «исключённого» и верни его в род, хотя бы мысленно.\n"
        "• Восстанови отношения с семьёй.\n"
        "• Научись просить помощи и принимать её с благодарностью."
    ),
    (15,5,8): (
        "Ты причинял боль близким — изменял, был алкоголиком, трудоголиком. "
        "Или, наоборот, страдал от предательства.\n\n"
        "В этой жизни тебя могут предавать, или ты сам будешь испытывать искушение причинить боль.\n"
        "Ты можешь чувствовать, что мир несправедлив.\n\n"
        "?<b>Задачи этого хвоста:</b>\n"
        "• Прости своих обидчиков.\n"
        "• Выбери любовь, даже когда хочется отомстить.\n"
        "• Понимай: мир справедлив. Ты не повторяешь сценарии прошлого."
    ),
    (3,9,12): (
        "Ты сильно любил и потерял любимого. Ты ждал его всю жизнь, не впуская другого.\n\n"
        "В этой жизни ты можешь оставаться одиноким, не впуская сердце. "
        "Или отношения будут формальными, без глубины.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Перестань ходить между ролями: преследователь — спасатель — жертва.\n"
        "• Полюби себя.\n"
        "• Перестань приносить себя в жертву ради других."
    ),
    (3,12,9): (
        "Ты сильно любил и потерял любимого. Ты ждал его всю жизнь, не впуская другого.\n\n"
        "В этой жизни ты можешь оставаться одиноким, не впуская сердце. "
        "Или отношения будут формальными, без глубины.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Перестань ходить между ролями: преследователь — спасатель — жертва.\n"
        "• Полюби себя.\n"
        "• Перестань приносить себя в жертву ради других."
    ),
    (9,12,3): (
        "Ты сильно любил и потерял любимого. Ты ждал его всю жизнь, не впуская другого.\n\n"
        "В этой жизни ты можешь оставаться одиноким, не впуская сердце. "
        "Или отношения будут формальными, без глубины.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Перестань ходить между ролями: преследователь — спасатель — жертва.\n"
        "• Полюби себя.\n"
        "• Перестань приносить себя в жертву ради других."
    ),
    (15,8,11): (
        "Ты обижал слабых, получал от этого удовольствие. "
        "В этой жизни ты можешь быть слабым физически, и над тобой могут издеваться.\n\n"
        "Ты можешь чувствовать злость на весь мир. "
        "Окружающие чувствуют твою внутреннюю агрессию.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Займись спортом — чтобы укрепить тело и выплеснуть агрессию.\n"
        "• Научись жить из любви, а не из ненависти.\n"
        "• Не обижай слабых — и тогда перестанут обижать тебя."
    ),
    (9,15,6): (
        "Ты жил в иллюзиях, в мире фантазий и страстей. "
        "Ты мог быть из другой цивилизации или стоял между любовью и страстью.\n\n"
        "В этой жизни ты можешь чувствовать себя чужаком. "
        "Жить в цифровом мире, уходить в алкоголь и наркотики.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Реализуй фантазии через творчество: писательство, кино.\n"
        "• Подними энергию страсти до уровня любви.\n"
        "• Научись принимать партнёра, не стремясь его изменить."
    ),
    (6,17,11): (
        "У тебя был талант, но ты не реализовал его. "
        "В этой жизни ты можешь жить в рутине, боясь начать.\n\n"
        "Ты можешь чувствовать, что способен на большее, но не знаешь, как начать.\n"
        "На рутинной работе будут провокации: повышение, деньги — чтобы проверить выбор.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Не повторяй ошибки прошлого.\n"
        "• Развивай талант, не впадая в пассивность.\n"
        "• Выходи в люди и свети на большие массы."
    ),
    (12,19,7): (
        "Ты убивал, воевал, получал удовольствие от борьбы. "
        "В этой жизни ты можешь быть агрессивным, воинственным.\n\n"
        "Карма наказывает за агрессию — сразу «по шапке». "
        "Может быть чувство вины и отказ от процветания.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Решай вопросы миром, не конкурируя.\n"
        "• Служи людям из любви, а не из чувства вины.\n"
        "• Спасай жизни: врач, психолог, спасатель."
    ),
    (21,4,10): (
        "Ты добровольно остался в рабстве или отказался от ответственности. "
        "Ты боялся выйти из зоны комфорта.\n\n"
        "В этой жизни ты можешь быть зависим от «костыля» — родителей, партнёра, начальника. "
        "Ты боишься принимать решения.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Проработай установки: «Я не смогу», «Я не умный».\n"
        "• Бери ответственность за свою жизнь.\n"
        "• Уйди с наёмной работы, стань хозяином своей судьбы."
    ),
    (3,22,19): (
        "Ты был абортирован или умер в раннем детстве. "
        "В этой жизни ты можешь искать маму, которой не хватало любви.\n\n"
        "Ты можешь испытывать искушение сделать аборт. "
        "Ты можешь чувствовать, что жизнь коротка и нужно всё успеть.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Не делай аборт — это отработка кармы.\n"
        "• Проживи второе детство — через профессию с детьми.\n"
        "• Прости женщин, которые делали аборты."
    ),
    (21,10,16): (
        "Ты обладал знаниями, но не передал их или использовал во вред. "
        "В этой жизни ты мог расти в семье, где было узкое мышление.\n\n"
        "Ты можешь заниматься саморазрушением: алкоголь, переедание. "
        "Отсутствует доверие к миру.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Помогай другим духовно пробудиться.\n"
        "• Развивай тело и дух: йога, медитации.\n"
        "• Понимай: тело, разум и душа — едины."
    ),
    (6,8,20): (
        "Ты опозорил свой род в прошлой жизни. "
        "В этой жизни семья может возлагать на тебя большие надежды.\n\n"
        "Ты можешь чувствовать, что мир несправедлив, что ты никому не нужен. "
        "Проблемы в отношениях, низкая самооценка.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Прославь род через реализацию своих талантов.\n"
        "• Стань гордостью рода, а не пытайся заслужить любовь.\n"
        "• Понимай: ты значим, твои чувства важны."
    ),
    (3,7,22): (
        "Ты нарушал чужие границы, был в тюрьме или в подчинении. "
        "В этой жизни ты можешь быть в долгах, кредитах, токсичных отношениях.\n\n"
        "Ты можешь чувствовать, что живёшь по чужой указке. "
        "Ты можешь подсознательно хотеть быть должным.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Помогай другим обрести свободу.\n"
        "• Избавься от зависимостей: долгов, алкоголя.\n"
        "• Прояви свободу воли, а не живи по указке."
    ),
    (9,3,21): (
        "Ты был карателем, получал удовольствие от контроля. "
        "В этой жизни ты можешь стремиться к власти, контролю.\n\n"
        "Ты можешь быть ревнивым, перфекционистом, не умеешь делегировать. "
        "Страх потерять контроль вызывает панические атаки.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Уважай свободу других.\n"
        "• Создай равные отношения.\n"
        "• Не зацикливайся на власти и деньгах."
    ),
    (21,7,13): (
        "Ты убивал массово, ради удовольствия или власти. "
        "В этой жизни ты должен спасать жизни.\n\n"
        "Ты можешь быть провокатором в словах. "
        "Возможны дети с тяжёлыми диагнозами.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Спасай жизни массово: хирург, психиатр, спасатель.\n"
        "• Уважай всех людей, не дели на «свой» и «чужой».\n"
        "• Помогай людям восстанавливаться после травм."
    ),
    (18,6,15): (
        "Ты причинял вред людям через магию, создавал оружие. "
        "В этой жизни ты можешь влиять на других, соблазнять, манипулировать.\n\n"
        "У тебя есть силы, ораторские данные, внешность. "
        "Ты можешь использовать это во вред или во благо.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Спасай и исцеляй людей.\n"
        "• Не манипулируй, а направляй к свету.\n"
        "• Определи: служишь ли ты свету или тьме."
    ),
    (6,20,14): (
        "Ты был принесён в жертву ради истины или ритуала. "
        "В этой жизни окружающие чувствуют вину и дают тебе всё просто так.\n\n"
        "Ты можешь быть черствым, закрытым, требовательным. "
        "Можешь осуждать других и не любить себя.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Будь благодарным за то, что даётся.\n"
        "• Раскрывай свою душу.\n"
        "• Полюби себя и принимай других."
    ),
    (21,10,7): (
        "Ты навязывал свои убеждения через силу, считая, что «так надо». "
        "Ты был сильным лидером, но действовал воинственно.\n\n"
        "В этой жизни ты хочешь убедить всех в своей правоте. "
        "Считаешь, что твоя информация — благо для людей.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Уважай выбор других.\n"
        "• Будь гибким, предлагай несколько вариантов.\n"
        "• Не дави на тех, кто не на гребне успеха."
    ),
    (3,13,10): (
        "Ты добровольно ушёл из жизни. "
        "В этой жизни ты можешь бояться ответственности, брака, продолжения рода.\n\n"
        "Ты можешь быть апатичным, ленивым, бояться жить. "
        "Жизнь может казаться бессмысленной.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Научись ценить жизнь.\n"
        "• Живи здесь и сейчас.\n"
        "• Пройди свой жизненный цикл до конца."
    ),
    (12,18,3): (
        "Ты сильно болел, был калекой, не принял боль. "
        "В этой жизни ты можешь стать инвалидом или бояться болезни.\n\n"
        "Ты можешь бояться заболеть, особенно после 40 лет. "
        "Может быть страх заботиться о больном.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Прими болезнь, если она пришла.\n"
        "• Помогай другим принимать страдания.\n"
        "• Не борись с реальностью — и тогда она может измениться."
    ),
    (18,3,12): (
        "Ты сильно болел, был калекой, не принял боль. "
        "В этой жизни ты можешь стать инвалидом или бояться болезни.\n\n"
        "Ты можешь бояться заболеть, особенно после 40 лет. "
        "Может быть страх заботиться о больном.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Прими болезнь, если она пришла.\n"
        "• Помогай другим принимать страдания.\n"
        "• Не борись с реальностью — и тогда она может измениться."
    ),
    (6,14,8): (
        "Ты был влиятельным лидером, запускавшим глобальные процессы. "
        "Ты чувствовал, что люди идут за тобой, не задумываясь.\n\n"
        "В этой жизни ты не осознаёшь своей силы. "
        "Ты чувствуешь себя никчёмным, сомневаешься в себе.\n"
        "При этом ты всё принимаешь на свой счёт.\n\n"
        "? <b>Задачи этого хвоста:</b>\n"
        "• Не бери на себя чужие эмоции.\n"
        "• Не додумывай за людей.\n"
        "• Концентрируйся на хорошем.\n"
        "• Будь коммуникабельным, не закрывайся."
    ),
}

# ——— ссылки на PDF-файлы ———
PDF_LINKS = {
    (18,6,6): "https://drive.google.com/file/d/10R1PoK8lQbcP5fEVVXecMoLymi45tsGW/view?usp=drive_link",
    (9,9,18): "https://drive.google.com/file/d/1QaMYUJv--n8iLwseG8_MAgz79dggEgg6/view?usp=drive_link",
    (9,18,9): "https://drive.google.com/file/d/1uRuiDM-csTgk6SGweSkhbGT20yfK1kXd/view?usp=drive_link",
    (18,9,9): "https://drive.google.com/file/d/10kDSS349TSu9eYaiCo61uWVjx11WOWRA/view?usp=drive_link",
    (6,5,17): "https://drive.google.com/file/d/1IOKcMbpaRniLBmPL8s-anCwi1eBrr_O9/view?usp=drive_link",
    (15,20,5): "https://drive.google.com/file/d/1t3mCNby-NCCBE4Pz_EFbuvXsJim9mpqG/view?usp=drive_link",
    (15,5,8): "https://drive.google.com/file/d/161NMgmh9KDcrK0og17JrHBSloSNYvNmz/view?usp=drive_link",
    (3,9,12): "https://drive.google.com/file/d/1w69XCIBm3u6XVTXJF893iL3nV_CzgaRJ/view?usp=drive_link",
    (3,12,9): "https://drive.google.com/file/d/1w69XCIBm3u6XVTXJF893iL3nV_CzgaRJ/view?usp=drive_link",
    (9,12,3): "https://drive.google.com/file/d/1w69XCIBm3u6XVTXJF893iL3nV_CzgaRJ/view?usp=drive_link",
    (15,8,11): "https://drive.google.com/file/d/14eTveJvncg3FRsOlGqBuiDD1Vd885BcE/view?usp=drive_link",
    (9,15,6): "https://drive.google.com/file/d/18wj_PCzN7ZEaUvfmGiDW2AttFdY15snQ/view?usp=drive_link",
    (6,17,11): "https://drive.google.com/file/d/18wj_PCzN7ZEaUvfmGiDW2AttFdY15snQ/view?usp=drive_link",
    (12,19,7): "https://drive.google.com/file/d/1RYUBW4pCeSmsXwcjjTLiWdXHWP1uud2z/view?usp=drive_link",
    (21,4,10): "https://drive.google.com/file/d/1O27XG5pSIcGbfsNSQILNTbNVdXxYbf5Z/view?usp=drive_link",
    (12,16,4): "https://drive.google.com/file/d/12EhO882TN6FFZNkV1LV18Gzy6SGTbJaF/view?usp=drive_link",
    (3,22,19): "https://drive.google.com/file/d/1BBgsTpA_twkhsgAly9i3DtR6fseIMlRa/view?usp=drive_link",
    (21,10,16): "https://drive.google.com/file/d/1unFYU8JlQPhYPmFgLlaRpDwX49TBP2WE/view?usp=drive_link",
    (6,8,20): "https://drive.google.com/file/d/1SdzrR0vieHPZsPI4oxAynQ8KUgN2wYkK/view?usp=drive_link",
    (3,7,22): "https://drive.google.com/file/d/1dM0z8LpAgNZEO2bViZXiJBQssG1MmFZh/view?usp=drive_link",
    (9,3,21): "https://drive.google.com/file/d/15pb7irKooMODIvkGacYGNQbGgngdp_w-/view?usp=drive_link",
    (21,7,13): "https://drive.google.com/file/d/1lPwcqfBzC9gUNdC_10QYPavb3v3N-YIS/view?usp=drive_link",
    (18,6,15): "https://drive.google.com/file/d/1PWq5Vf6nBrL0eZPWXJa4SmLHsdbJIoKc/view?usp=drive_link",
    (6,20,14): "https://drive.google.com/file/d/1kugwosiU6g31pPujfCZfSo9WGDouzIJ6/view?usp=drive_link",
    (21,10,7): "https://drive.google.com/file/d/1vl2gBjs_jQBDHakFJBsHr4uU7OaGsPnn/view?usp=drive_link",
    (3,13,10): "https://drive.google.com/file/d/10_7IQ-bHmJnmmzYLwpF06NDKlRhavJUV/view?usp=drive_link",
    (12,18,3): "https://drive.google.com/file/d/1e1xcWuo1uYHDLYGJGkzhP1niun92kUUP/view?usp=drive_link",
    (18,3,12): "https://drive.google.com/file/d/1e1xcWuo1uYHDLYGJGkzhP1niun92kUUP/view?usp=drive_link",
    (6,14,8): "https://drive.google.com/file/d/1WC9HbCl6PfDasDX1uYM6qcF7nvFO8JcS/view?usp=drive_link",
}
# ——— кнопки ———
start_keyboard = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="Сделать полный анализ")],
        [KeyboardButton(text="Подписаться на канал Master Mystic")]
    ],
    resize_keyboard=True
)

subscribe_button = InlineKeyboardMarkup(
    inline_keyboard=[
        [InlineKeyboardButton(text="Подписаться", url="https://t.me/Master_Mystic")]
    ]
)

# ——— команда /start ———
@dp.message(Command("start"))
async def start(message: Message):
    await message.answer(
        "Привет! Я — бот <b>Master Mystic</b> ??\n\n"
        "Я помогу рассчитать твой <i>Кармический хвост</i> и узнать главные задачи души, которые ты притащил(а) из прошлой жизни. Что мешает тебе двигаться вперёд.\n\n"
        "Это бесплатно.\n\n"
        "Введите дату рождения в формате <b>ДД.ММ.ГГГГ</b>",
        reply_markup=start_keyboard
    )

# ——— обработчик "Подписаться на канал Master Mystic" ———
@dp.message(F.text == "Подписаться на канал Master Mystic")
async def subscribe(message: Message):
    # Отправляем только кнопку (без текста)
    await message.answer(
        reply_markup=subscribe_button
    )

# ——— обработчик "Сделать полный анализ" ———
@dp.message(F.text == "Сделать полный анализ")
async def full_analysis(message: Message):
    payment_button = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="? Продолжить", callback_data="pay")],
            [InlineKeyboardButton(text="? Я подумаю", callback_data="think")]
        ]
    )
    await message.answer(
        "<b>Отлично! В полном анализе ты узнаешь:</b>\n"
        "? Денежный код\n"
        "? Призвание и путь души\n"
        "? Кармические задачи\n"
        "? Зоны силы и слабости\n\n"
        "<b>?? Полный анализ по Матрице судьбы будет стоить 1000?.</b>\n\n"
        "Это не гадание, это анализ по дате рождения. Хочешь получить? Жми «Продолжить» — и я пришлю реквизиты для оплаты. После оплаты — в течение 24 часов пришлю подробный расчёт.",
        reply_markup=payment_button
    )

# ——— обработка "Продолжить" ———
@dp.callback_query(F.data == "pay")
async def send_payment_info(callback):
    payment_info = (
        "?? <b>Реквизиты для оплаты:</b>\n\n"
        "Сбербанк: <code>4276 5400 2708 8180</code>\n\n"
        "После оплаты нажми кнопку <b>ГОТОВО</b> — и я пришлю расчёт."
    )
    ready_button = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="? ГОТОВО", callback_data="ready")]
        ]
    )
    await callback.message.edit_text(payment_info, reply_markup=ready_button, parse_mode="HTML")

# ——— обработка "ГОТОВО" ———
@dp.callback_query(F.data == "ready")
async def send_contact(callback):
    # Запрос даты рождения
    await callback.message.edit_text(
        "Пожалуйста, введите вашу дату рождения в формате <b>ДД.ММ.ГГГГ</b> (например, 15.04.1990):",
        reply_markup=None,
        parse_mode="HTML"
    )

# ——— обработка ввода даты рождения ———
@dp.message(F.text.regexp(r"^(0[1-9]|[12][0-9]|3[01])\.(0[1-9]|1[0-2])\.(\d{4})$"))
async def process_date(message: Message):
    try:
        day, month, year = map(int, message.text.split("."))
    except:
        await message.reply("?? Ошибка формата даты. Введите в формате ДД.ММ.ГГГГ.")
        return

    if not (1 <= day <= 31) or not (1 <= month <= 12) or year < 1900:
        await message.reply("?? Введите корректную дату.")
        return

    # Отправляем дату в ваш аккаунт
    await bot.send_message(
        chat_id="@Mattrehka",
        text=f"Новый клиент: {message.from_user.full_name}\nДата рождения: {day}.{month}.{year}"
    )

    # Сообщение клиенту
    await message.answer(
        "Спасибо за доверие ??. В течение 24 часов я пришлю вам результат. "
        "Если у вас будут вопросы, пишите в личные сообщения <a href='https://t.me/Mattrehka'>Master Mystic</a>",
        parse_mode="HTML"
    )

# ——— обработка "Я подумаю" ———
@dp.callback_query(F.data == "think")
async def think_callback(callback):
    await callback.message.edit_text(
        "Хорошо. А пока можешь подписаться на канал <a href='https://t.me/Master_Mystic'>Master Mystic</a>. "
        "Многие, кто получил свой хвост, уже в канале. Присоединяйся — там живёт самая сильная энергия.",
        reply_markup=None,
        parse_mode="HTML"
    )

# ——— обработчик даты ———
@dp.message(F.text.regexp(r"^(0[1-9]|[12][0-9]|3[01])\.(0[1-9]|1[0-2])\.(\d{4})$"))
async def handle_date(message: Message):
    try:
        day, month, year = map(int, message.text.split("."))
    except:
        await message.reply("?? Ошибка обработки даты. Попробуйте снова.")
        return

    if not (1 <= day <= 31) or not (1 <= month <= 12) or year < 1900:
        await message.reply("?? Введите корректную дату.")
        return

    tail_triplet = calc_tail(day, month, year)
    description = describe_tail(tail_triplet)
    detailed_text = DETAILED_DESCRIPTIONS.get(tail_triplet, "Подробное описание пока недоступно.")

    # Комбинированные кнопки: "Читать полностью" и "Сделать полный анализ"
    combined_buttons = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="?? Читать полностью", url=PDF_LINKS.get(tail_triplet, "#"))],
            [InlineKeyboardButton(text="?? Сделать полный анализ", callback_data="full_analysis")]
        ]
    )

    # Отправляем результат с двумя кнопками
    await message.answer(
        f"?? <b>Твой кармический хвост:</b> {tail_triplet[0]}-{tail_triplet[1]}-{tail_triplet[2]}\n"
        f"?? {description}\n\n"
        f"{detailed_text}",
        reply_markup=combined_buttons
    )

    # Отправляем кнопку подписки отдельно (без текста)
    await message.answer(
        reply_markup=subscribe_button
    )

# ——— обработка нажатия на кнопку "Сделать полный анализ" ———
@dp.callback_query(F.data == "full_analysis")
async def callback_full_analysis(callback):
    payment_button = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="? Продолжить", callback_data="pay")],
            [InlineKeyboardButton(text="? Я подумаю", callback_data="think")]
        ]
    )
    await callback.message.edit_text(
        "<b>Отлично! В полном анализе ты узнаешь:</b>\n"
        "? Денежный код\n"
        "? Призвание и путь души\n"
        "? Кармические задачи\n"
        "? Зоны силы и слабости\n\n"
        "<b>?? Полный анализ по Матрице судьбы будет стоить 1000?.</b>\n\n"
        "Это не гадание, это анализ по дате рождения. Хочешь получить? Жми «Продолжить» — и я пришлю реквизиты для оплаты. После оплаты — в течение 24 часов пришлю подробный расчёт.",
        reply_markup=payment_button
    )

# ——— запуск бота ———
async def main():
    from aiohttp import web
    from aiogram.webhook.aiohttp_server import SimpleRequestHandler

    await bot.set_webhook(WEBHOOK_URL)
    app = web.Application()
    SimpleRequestHandler(dispatcher=dp, bot=bot).register(app, path="/webhook")
    runner = web.AppRunner(app)
    await runner.setup()
    site = web.TCPSite(runner, host="0.0.0.0", port=int(os.getenv("PORT", 10000)))
    await site.start()
    print(f"? Бот запущен. Вебхук: {WEBHOOK_URL}")
    try:
        await asyncio.sleep(3600)
    finally:
        await runner.cleanup()

if __name__ == "__main__":
    asyncio.run(main())
